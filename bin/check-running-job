#!/bin/bash

[[ $# -eq 0 ]] && echo "No app provided" && exit 1

# Get wait arugment if supplied
if [[ -n $2 && $2 == '--wait' ]]; then
    wait_for_app='true'
fi

# Input any app name
if [[ -n "$1" ]]; then
    app_to_check=$1
fi

# Check jq
if ! command -v jq &> /dev/null
then
    apt install -y jq
fi

# Check if deployment is happening, if so ignore
guid=$(cf app "$app_to_check" --guid)
echo "guid $guid"
running=$(\
    cf curl "/v3/deployments?status_values=ACTIVE" \
    | jq --arg guid "$guid" ".resources[] |
        select(.relationships.app.data.guid == \$guid ) |
        .relationships.app.data.guid" \
)
echo "running $running"
if [[ $running != "" ]]; then
    if [[ $wait_for_app == 'true' ]]; then
            echo "Waiting on running job $running.."
            sleep 10
            check_running_job "$1" "$2"
    else
        echo "Deployment in progress for $app_to_check, not doing anything"
        exit 0
    fi
fi

# If there is more than one instance of 'instances', the app is already restarting
if [[ $(cf app "$app_to_check" | grep -c '^instances:') -gt 1 ]]; then
  echo "Deployment or Restart in progress... not doing anything"
  exit 0
fi
